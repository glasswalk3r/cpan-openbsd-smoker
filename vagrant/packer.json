{
  "post-processors": [
    [
      {
        "type": "vagrant",
        "output": "{{user `box`}}"
      },
      {
          "type": "checksum",
          "checksum_types": ["sha256"]
      }
    ]
  ],
  "variables": {
    "mysql_root_pass": "vagrant",
    "openbsd_version": null,
    "openbsd_mirror": null,
    "openbsd_architecture": null,
    "timezone": null,
    "local_mirror": null,
    "iso_path": null,
    "iso_sha": null,
    "guest_os_type": null,
    "box": null,
    "pkg_path": "https://{{user `openbsd_mirror`}}/pub/OpenBSD/{{user `openbsd_version`}}/packages/{{user `openbsd_architecture`}}/"
  },
  "provisioners": [
    {
      "type": "file",
      "source": "packer/adduser.conf",
      "destination": "/tmp/adduser.conf"
    },
    {
      "type": "file",
      "source": "packer/mysql-perf.txt",
      "destination": "/tmp/mysql-perf.txt"
    },
    {
      "type": "file",
      "source": "packer/mariadb",
      "destination": "/tmp/mariadb"
    },
    {
      "type": "file",
      "source": "packer/mariadb-user.sql",
      "destination": "/tmp/mariadb-user.sql"
    },
    {
      "type": "shell",
      "inline": [
        "mv /tmp/adduser.conf /etc/adduser.conf",
        "chmod 644 /etc/adduser.conf",
        "chown root.wheel /etc/adduser.conf"
      ]
    },
    {
      "type": "file",
      "source": "packer/packages.txt",
      "destination": "/tmp/packages.txt"
    },
    {
      "type": "shell",
      "environment_vars": [
        "LOCAL_MIRROR={{user `local_mirror`}}",
        "PKG_PATH={{user `pkg_path`}}"
      ],
      "inline": [
        "echo 'PS1=\"[\\u@\\h:\\w]$ \"' > /etc/profile",
        "echo 'PKG_PATH={{user `pkg_path`}}; export PKG_PATH' >> /root/.profile",
        "sed -i -e \"s#libpth => '/usr/lib /usr/lib'#libpth => '/usr/lib /usr/local/lib'#\" /usr/libdata/perl5/{{user `openbsd_architecture`}}-openbsd/Config.pm",
        "sed -i -e \"s#libpth='/usr/lib /usr/lib'#libpth='/usr/lib /usr/local/lib'#\" /usr/libdata/perl5/{{user `openbsd_architecture`}}-openbsd/Config_heavy.pl",
        "/usr/sbin/pkg_add -l /tmp/packages.txt",
        "/usr/local/bin/mysql_install_db",
        "/usr/sbin/rcctl enable mysqld",
        "sed -i -E 's/^(log-bin=)/#\\1/' /etc/my.cnf",
        "sed -i -E 's/^(binlog_format=)/#\\1/' /etc/my.cnf",
        "/usr/sbin/rcctl start mysqld",
        "sed -i -f /tmp/mysql-perf.txt /etc/my.cnf",
        "/usr/sbin/rcctl restart mysqld",
        "/usr/local/bin/expect -f /tmp/mariadb",
        "/usr/local/bin/mysql -u root < /tmp/mariadb-user.sql",
        "echo 'vagrant ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers",
        "groupadd testers",
        "usermod -G wheel,testers vagrant",
        "mkdir /mnt/cpan_build_dir",
        "chgrp testers /mnt/cpan_build_dir",
        "chmod g+w /mnt/cpan_build_dir",
        "sed -i -E 's/^(PermitRootLogin )yes/\\1no/' /etc/ssh/sshd_config",
        "echo 'bootstraping vagrant user'",
        "/usr/bin/su vagrant -c 'mkdir -p /home/vagrant/.ssh'",
        "/usr/bin/su vagrant -c 'wget https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub --output-document /home/vagrant/.ssh/authorized_keys'",
        "/usr/bin/su vagrant -c 'chmod 700 /home/vagrant/.ssh'",
        "/usr/bin/su vagrant -c 'chmod 600 /home/vagrant/.ssh/authorized_keys'"
      ]
    }
  ],
  "builders": [
    {
      "boot_command": [
        "S<enter>",
        "cat <<EOF >> openbsd.disklabel<enter>",
        "/ 250M<enter>",
        "swap 1548M<enter>",
        "/home 35G<enter>",
        "/minicpan 5G<enter>",
        "/usr 10G<enter>",
        "/var 500M<enter>",
        "/tmp 1G-*<enter>",
        "EOF<enter>",
        "cat <<EOF >>install.conf<enter>",
        "System hostname = openbsd{{user `openbsd_version`}}<enter>",
        "Which network interface do you wish to configure? (or 'done') em0<enter>",
        "IPv4 address for em0? (or 'dhcp' or 'none') dhcp<enter>",
        "Which network interface do you wish to configure? (or 'done') done<enter>",
        "Password for root = vagrant<enter>",
        "Setup a user = vagrant<enter>",
        "Password for user = vagrant<enter>",
        "Allow root ssh login = yes<enter>",
        "What timezone are you in = {{user `timezone`}}<enter>",
        "Location of sets = cd0<enter>",
        "Set name(s) = -game*.tgz -xshare*.tgz -xfont*.tgz -xserv*.tgz <enter>",
        "Directory does not contain SHA256.sig. Continue without verification = yes<enter>",
        "URL to autopartitioning template for disklabel = file:///openbsd.disklabel<enter>",
        "EOF<enter>",
        "install -af install.conf && reboot<enter>"
      ],
      "type": "virtualbox-iso",
      "guest_os_type": "{{user `guest_os_type`}}",
      "iso_url": "file://{{user `iso_path`}}",
      "iso_checksum": "{{user `iso_sha`}}",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "shutdown_command": "/sbin/halt -p",
      "guest_additions_mode": "disable",
      "boot_wait": "30s",
      "disk_size": 55000,
      "output_directory": "",
      "ssh_wait_timeout": "10000s",
      "vm_name": "openbsd{{user `openbsd_version`}}-base",
      "vboxmanage": [
        [
          "modifyvm",
          "{{.Name}}",
          "--memory",
          "2048"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--cpus",
          "2"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--natdnspassdomain1",
          "off"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--natdnshostresolver1",
          "on"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--uartmode1",
          "disconnected"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--nic1",
          "nat",
          "--nictype1",
          "82540EM"
        ],
        [
          "modifyvm",
          "{{.Name}}",
          "--vrde",
          "off"
        ]
      ]
    }
  ]
}
